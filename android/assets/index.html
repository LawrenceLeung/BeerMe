<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
  "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta name="viewport" content="width=320; user-scalable=no" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>PhoneGap</title>
	  <link rel="stylesheet" href="master.css" type="text/css" media="screen" title="no title" charset="utf-8">
	  <script type="text/javascript" charset="utf-8" src="phonegap.js"></script>
	  <script src="http://maps.google.com/maps?file=api&v=2&key=ABQIAAAASWkdhwcFZHCle_XL8gNI0hQQPTIxowtQGbc0PVHZZ3XLXr5GBhRKV3t_-63J9ZAJ2bYu3zsQdR9N-A&sensor=true" type="text/javascript"></script>
	  <script type="text/javascript" src="yql_js_widget.js"></script>
	  <script type="text/javascript" charset="utf-8">
	// Geolocation code shamelessly stolen from Movable Type scripts: http://www.movable-type.co.uk/scripts/latlong.html
	LatLon.distCosineLaw = function(lat1, lon1, lat2, lon2) {
		var R = 6371; // earth's mean radius in km
		var d = Math.acos(Math.sin(lat1.toRad())*Math.sin(lat2.toRad()) +
			Math.cos(lat1.toRad())*Math.cos(lat2.toRad())*Math.cos((lon2-lon1).toRad())) * R;
		return d;
	};
	function LatLon(lat, lon) {
		this.lat = lat;
		this.lon = lon;
	}
	Number.prototype.toRad = function() {  // convert degrees to radians
		return this * Math.PI / 180;
	};
    // Beer Me JS code.
    var BeerMe = {
 		// Create our droid and beer marker icon
    	droidIcon:new GIcon(G_DEFAULT_ICON),
    	droidMarkerOptions:null,
    	beerIcon:new GIcon(G_DEFAULT_ICON),
    	beerMarkerOptions:null,
    	myMarkerInfo:document.createElement("div"),
    	myMarker:null,
    	map:null,
    	geocoder:null,
    	disableRefresh:function() {
            var btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.innerHTML = 'Refreshing...';
        },
        enableRefresh:function() {
        	var btn = document.getElementById('refreshBtn');
            btn.disabled = false;
            btn.innerHTML = 'Refresh location';
        },
        updateLocation:function() {
            BeerMe.disableRefresh();
        	var suc = function(p) {
          		var point = new GLatLng(p.coords.latitude, p.coords.longitude);
          		// Draw my position.
          		BeerMe.myMarker.setLatLng(point);
          		BeerMe.map.addOverlay(BeerMe.myMarker);
          		// Set map center.
          		BeerMe.map.setCenter(point, 10);
          		// Call for YQL data.
          		BeerMe.beerUpdate(p.coords.latitude, p.coords.longitude);
          		BeerMe.enableRefresh();
    		};
    		var die = function() {
    			document.getElementById('refreshBtn').innerHTML = 'GPS is unavailable';
      			alert('GPS Failure! Please enable GPS to be able to use Beer Me.');
    		};
      		navigator.geolocation.getCurrentPosition(suc,die);
        },
        getBeerFromBeerMapping:function(lat,lng) {
            var cb_GeoCoderReverse = function(response) {
            	// Calback for retrieving geographic information about current location.
                // TODO: Handle status code 602: Unknown area.
            	if (!response || response.Status.code != 200) {
            		alert("Error retrieving data from BeerMapping.com, status code:" + response.Status.code);
            	} else {
                	// If we get data back about our location, make a call to BeerMapping.
                	if (response.Placemark.length > 0) {
	              		var place = response.Placemark[0];
	              		var state = "";
	              		try {
	              			//var city = place.AddressDetails.Country.AdministrativeArea.SubAdministrativeArea.SubAdministrativeAreaName;
	              			state = place.AddressDetails.Country.AdministrativeArea.AdministrativeAreaName;
	              		} catch(e) {
		              		alert('Could not properly geocode your location and thus determine what state/province you are in, so only showing results from YQL.'); 
				            console.log("Can't retrieve geocoded state/province from Google service. Exception: " + e.toString());
	              		}
	              		if (state.length > 0) {
		              		var url = "http://beermapping.com/webservice/locstate/33aac0960ce1fd70bd6e07191af96bd5/" + state;
		              		var BeerXHR = new XMLHttpRequest();
		              		// And this is the BeerMapping callback.
		                	var cb_BeerMapping = function() {
		                    	if (BeerXHR.readyState == 4 && BeerXHR.status == 200) {
		                        	// Grab response and parse!
		                        	var response = BeerXHR.responseXML.documentElement;
		                        	var locations = response.getElementsByTagName('location');
		                        	for (var i = 0; i < locations.length; i++) {
		                        		function createBMBeerMarker(node) {
		                        			var beerMarker = new GMarker(new GLatLng(0,0), BeerMe.beerMarkerOptions);
		                        		    GEvent.addListener(beerMarker, "click", function() {
		                        		    	var myHtml = "<b>" + node.Title + "</b><br/>" + node.Street + "<br/>" + node.City + ", " + node.State + "<br/>" + "BeerMapping location!"; 
		                        		    	beerMarker.openInfoWindowHtml(myHtml);
		                        		    });
		                        		    return beerMarker;
		                        		}
		                            	try {
		                                	var name = locations[i].getElementsByTagName('name')[0].childNodes[0].nodeValue;
		                            		var city = locations[i].getElementsByTagName('city')[0].childNodes[0].nodeValue;
		                            		var street = locations[i].getElementsByTagName('street')[0].childNodes[0].nodeValue;
		                            		var state = locations[i].getElementsByTagName('state')[0].childNodes[0].nodeValue;
		                            		if (city != null && street != null && state != null) {
		                                		// Callback for getting lat/lng coords of BeerMapping locations.
		                                		var node = {
		                                        		"Title":name,
		                                        		"Street":street,
		                                        		"City":city,
		                                        		"State":state
		                                        };
		                                		var thisMarker = createBMBeerMarker(node);
		                                		console.log("Created BM marker '" + name + "' @ " + street);
		                                		var cb_GeoCoder = function(resp) {
		                                    		if (!resp || resp.Status.code != 200) {
		                                        		console.log('Geocoding response invalid.');
		                                    		} else {
		                                        		// Grab coord info.
		                                    			var bar = resp.Placemark[0];
		                                    			var barLng = bar.Point.coordinates[0];
		                                    			var barLat = bar.Point.coordinates[1];
		                                    			console.log('Setting BM marker at ' + barLat + ', ' + barLng);
		                                    			thisMarker.setLatLng(new GLatLng(barLat,barLng));
		                                    			BeerMe.map.addOverlay(thisMarker);
		                                    		}
		                                		}
		                                		var addressString = street + ", " + city + ", " + state;
		                                		BeerMe.geocoder.getLocations(addressString, cb_GeoCoder);
		                            		}
		                            	} catch (e) {
		                                	console.log('Error while processing BeerMapping locations, exception: ' + e.toString());
		                                	continue;
		                            	}
		                        	}
		                    	}	
		                	}
		              		BeerXHR.onreadystatechange = cb_BeerMapping;
		              		BeerXHR.open("GET", url, true);
		              		BeerXHR.send(null);
	              		}
                	} else {
                    	alert('Could not properly geocode your location, so only showing results from YQL.');
                	}
            	}
            };
        	// Get city name of current place.
        	BeerMe.geocoder.getLocations(new GLatLng(lat,lng),cb_GeoCoderReverse);
        },
        getBeerFromYQL:function(lat,lng) {
        	// Get data from YQL.
        	var config = {'debug' : true};
        	var format = '{Title}';
        	var yqlQuery = "select * from local.search where radius=35 and latitude=" + lat + " and longitude=" + lng + " and query='beer'";
        	var insertEl = 'widgetContainer';
        	yqlWidget.push(yqlQuery, config, format, insertEl, BeerMe.map);
        	yqlWidget.render();
        },
        beerUpdate:function(lat,lng) {
        	BeerMe.getBeerFromYQL(lat,lng);
        	BeerMe.getBeerFromBeerMapping(lat,lng);
        }
    };
    BeerMe.droidIcon.image = "images/androidmarker.png";
    BeerMe.droidIcon.iconSize = new GSize(50,58);
    BeerMe.droidMarkerOptions = { icon:BeerMe.droidIcon };
    BeerMe.beerIcon.image = "images/beericon.png";
    BeerMe.beerIcon.iconSize = new GSize(40,45);
    BeerMe.beerMarkerOptions = { icon:BeerMe.beerIcon };
	BeerMe.myMarkerInfo.innerHTML = 'Your position';
	BeerMe.myMarker = new GMarker(new GLatLng(0,0), BeerMe.droidMarkerOptions);
    GEvent.addListener(BeerMe.myMarker, "click", function() {
    	var myHtml = "<b>Your position</b>";
    	BeerMe.myMarker.openInfoWindowHtml(myHtml);
    });
    function initialize() {
    	BeerMe.map = new GMap2(document.getElementById("map_canvas"));
    	BeerMe.map.addControl(new GLargeMapControl);
    	BeerMe.geocoder = new GClientGeocoder();
    	BeerMe.updateLocation();
    }
	  </script>
  </head>
  <body onload="/*TODO: Check for GPS/Internet availability.*/setTimeout('initialize()',2500)" onunload="GUnload()" id="stage" class="theme">
  <div id="map_cont" style="width:100%;padding:2px;height:279px;">
  	<div id="map_canvas" style="width:100%;height:100%;z-index:1;"></div>
  </div>
  <button id="refreshBtn" onclick="updateLocation();" style="width:100%;height:20px;">Refresh location</button>
  <div id="widgetContainer" style="width:100%;height:120px;overflow-y:scroll;"></div>
  </body>
</html>